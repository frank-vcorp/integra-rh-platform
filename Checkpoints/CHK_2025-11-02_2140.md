# Checkpoint: Firebase Auth 401 loop fixed (2025-11-02 21:40)

Resumen
- Síntoma: Tras login con Google, el cliente regresaba a /login y las llamadas `/api/trpc/auth.me` devolvían 401.
- Server log: "Unable to detect a Project Id in the current environment" al verificar el ID token (Firebase Admin).
- Estado: Resuelto. Autenticación estable y `auth.me` OK.

Causas raíz
- Firebase Admin se inicializaba sin `projectId`, dependiendo de ADC (Application Default Credentials). En local, ADC no estaba configurado ➜ `verifyIdToken` fallaba.
- En el cliente, el popup de Google puede fallar/bloquearse; sin fallback, el estado de sesión no se estabiliza.

Cambios aplicados
- Admin sin dependencias de ADC; se usa `projectId` explícito de env y bucket configurado:
  - integra-rh-manus/server/firebase.ts:1
- Fallback de login a redirect y manejo de `getRedirectResult` para estabilizar sesión al volver:
  - integra-rh-manus/client/src/pages/Login.tsx:1
- Env actualizado con `FIREBASE_PROJECT_ID=integra-rh` y variables VITE ya presentes:
  - integra-rh-manus/.env:1

Variables requeridas (.env)
- Servidor: `FIREBASE_PROJECT_ID`, `FIREBASE_STORAGE_BUCKET` (opcional si default aplica), `PORT` (opcional).
- Cliente: `VITE_API_URL`, `VITE_FIREBASE_API_KEY`, `VITE_FIREBASE_AUTH_DOMAIN`, `VITE_FIREBASE_PROJECT_ID`, `VITE_FIREBASE_APP_ID`, `VITE_FIREBASE_MESSAGING_SENDER_ID`, `VITE_FIREBASE_MEASUREMENT_ID`, `VITE_APP_TITLE`, `VITE_APP_LOGO`.

Requisitos en Firebase Console
- Authentication > Sign-in method > Google: Enabled.
- Authentication > Settings > Authorized domains: incluir `localhost` y `127.0.0.1`.

Cómo reproducir verificación
1) Server dev: `pnpm tsx watch ./server/_core/index.ts` (NODE_ENV=development recomendado).
2) Front: abrir http://localhost:3000, iniciar sesión con Google.
3) Network: `/api/trpc/auth.me` debe responder 200 y llevar `Authorization: Bearer <idToken>`.
4) Server: no debe aparecer "Unable to detect a Project Id…".

Notas
- `verifyIdToken` usa certificados públicos; con `projectId` basta para entornos locales (no requiere ADC/credenciales para verificar).
- Si se desea, se puede proporcionar `GOOGLE_APPLICATION_CREDENTIALS` (service account) y el código lo usará automáticamente, pero no es obligatorio.


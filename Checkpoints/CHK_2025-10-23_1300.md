# Dossier de Checkpoint: INTEGRA-RH

**ID del Checkpoint:** 2025-10-23_1300

**Módulo/Componente:** `FEAT-ADM-01: Módulo de Administración de Usuarios` + `ARCH-IMP-01: Migración a Firebase SDK v9`

**Agente Principal:** Codex-CLI

**Tareas PROYECTO.md Asociadas:** `FEAT-ADM-01` (Desbloqueado), `ARCH-IMP-01` (Completado en Frontend)

---

## 1. Resumen Ejecutivo (Para Dirección)

**Objetivo:** Desbloquear el panel de administración de usuarios (carga de usuarios) y migrar el frontend a Firebase v9 modular para resolver el problema de autenticación en funciones `onCall`.

**Resultado:** El panel de administración ya carga usuarios correctamente. Se completó la migración del frontend a SDK v9 modular (Auth, Functions, Firestore, Storage, App Check). Se añadió un fallback HTTP (`listUsersHttp`) como vía segura en caso de que la callable `listUsers` reciba 401 por escenarios residuales.

---

## 2. Snapshot Técnico (Continuidad IA)

### 2.1. Cambios Clave en Frontend (`public/index.html`)

- Migración total a v9 modular con `type="module"` e imports desde CDN:
  - `initializeApp`, `getAuth`, `onAuthStateChanged`, `signInWithEmailAndPassword`, `signOut`.
  - `getFunctions`, `httpsCallable` con región `us-central1`.
  - `getFirestore`, `collection`, `doc`, `getDoc`, `getDocs`, `addDoc`, `updateDoc`, `onSnapshot`, `query`, `where`, `orderBy`, `serverTimestamp`.
  - `getStorage`, `ref`, `uploadBytes`, `getDownloadURL`.
  - `initializeAppCheck`, `ReCaptchaV3Provider`, `getToken`.
- Inicialización de configuración sin depender de `init.js`:
  - Se obtiene `firebaseConfig` vía `fetch('/__/firebase/init.json')` y se llama `initializeApp(cfg)`.
- Reemplazos funcionales:
  - Firestore: de `db.collection(...).onSnapshot/get/add/update` a API modular equivalente.
  - Storage: de `storage.ref(...).put()/getDownloadURL()` a `ref/uploadBytes/getDownloadURL`.
  - Functions: de `functions.httpsCallable('...')` a `httpsCallable(functions, '...')`.
  - Auth: listeners y login/logout con API modular.
- Corrección de sintaxis y API v9:
  - `onSnapshot(doc(...), async (candDoc) => { if (!candDoc.exists()) return; ... })`.
- Fallback robusto para usuarios:
  - Si `httpsCallable('listUsers')` devuelve `unauthenticated`, intenta:
    1) `GET /listUsersHttp` (rewrite en Hosting), y si 404
    2) `GET https://us-central1-<project>.cloudfunctions.net/listUsersHttp`.
  - Adjunta `Authorization: Bearer <ID_TOKEN>` y `X-Firebase-AppCheck` (si disponible).
  - Se fuerza `getIdToken(true)` antes de operaciones admin para token fresco.

### 2.2. Cambios en Backend (`functions/index.js`)

- `listUsers` (onCall):
  - Logs de diagnóstico (`hasAuth`, `hasToken`, `authUid`, `authEmail`) y mejor manejo de errores.
- `listUsersHttp` (onRequest):
  - Verifica `Authorization: Bearer <ID_TOKEN>` con `verifyIdToken`.
  - Exige claim `role === 'superAdmin'`.
  - Maneja CORS y preflight `OPTIONS` (`Access-Control-Allow-*`).
  - Retorna `{ success: true, users: [...] }` en formato idéntico a la callable.

### 2.3. Configuración (`firebase.json`)

- Rewrites de Hosting activos:
  - `"/listUsersHttp" -> function "listUsersHttp"`.
  - También `asignarPruebasPsicometricas`, `reenviarInvitacion`, `manageUserRole`, `listUsers`.

---

## 3. Observaciones y Lecciones

- La raíz del 401 en `onCall` estuvo ligada a incompatibilidades entre SDK v8 y el runtime actual. La migración a v9 modular elimina la dependencia del namespace global y mejora el attach de tokens.
- `__/firebase/init.js` requiere `window.firebase` en enfoques compat; para modular puro es preferible usar `__/firebase/init.json`.
- El fallback HTTP permitió operar mientras se estabilizaba la callable y ayuda ante despliegues desincronizados (404) o CORS.
- Asegurar despliegue de Functions + Hosting tras añadir endpoints/rewrite; de lo contrario, la app cae en 404 o preflight sin CORS.

---

## 4. Estado y Validación

- Estado: Usuarios cargan correctamente en el panel admin.
- Validación:
  - Login OK con v9 modular.
  - Carga de usuarios OK (callable o fallback HTTP según entorno).
  - Logs de `listUsers` disponibles para confirmar `hasAuth/hasToken`.

---

## 5. Siguientes Pasos Recomendados

- Confirmar en producción que `listUsers` (onCall) ya no devuelve 401; si es estable, retirar el fallback HTTP del frontend.
- (Opcional) Añadir `manageUserRoleHttp` como respaldo simétrico mientras se valida `onCall` de roles.
- Revisar reglas de seguridad y claims (asignación de `superAdmin`) para minimizar errores de permisos.
- Mantener variables de entorno (SendGrid, Psicométricas) al día; no se alteraron en esta sesión.

---

## 6. Archivos Clave Modificados

- MODIFY: `public/index.html`
- MODIFY: `functions/index.js`
- MODIFY: `firebase.json`

---

## 7. Notas Operativas

- Despliegues:
  - Hosting: `firebase deploy --only hosting`.
  - Functions: `firebase deploy --only functions:listUsersHttp` (para habilitar el fallback) o `--only functions` si hay más cambios.
- Limpiar caché de navegador (Ctrl+F5) tras desplegar para evitar scripts antiguos.

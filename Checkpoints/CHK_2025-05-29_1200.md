# Dossier de Checkpoint: INTEGRA-RH

**ID del Checkpoint:** 2025-05-29_1200

**Módulo/Componente:** `FEAT-SEC-01: Implementar Roles y Permisos para Clientes (Backend)`

**Agente Principal:** Frank-Director

**Tareas PROYECTO.md Asociadas:** `FEAT-SEC-01` (En Progreso)

---

## 1. Resumen Ejecutivo (Para el Director de Proyecto)

**Objetivo de la Sesión:** Iniciar la construcción del portal para clientes, comenzando por la pieza más crítica: la infraestructura de seguridad y gestión de roles en el backend.

**Estado al Finalizar:** **Iniciado.** Se ha implementado con éxito la Cloud Function `setClientRole`, que servirá como la herramienta administrativa para que Paula pueda asignar permisos de cliente a usuarios específicos. La base de la arquitectura de seguridad está establecida.

---

## 2. Snapshot Técnico (Para Continuidad de IA)

### 2.1. Descripción Funcional

Se ha creado una Cloud Function `onCall` llamada `setClientRole`. Su propósito es permitir que un usuario administrador (identificado por el custom claim `{admin: true}`) asigne a otro usuario un rol de 'cliente'. La función recibe el email del usuario a promover y el ID del cliente al que será asociado, y le asigna los custom claims `{role: 'client', clientId: '...'}`. Esto sienta las bases para un modelo de seguridad multi-tenant, donde las reglas de Firestore podrán filtrar el acceso a los datos basándose en estos claims.

### 2.2. Checklist de Tareas Técnicas Completadas

[x] **Priorización de Tareas:** Se movió la tarea `FEAT-SEC-01` a la columna "En Progreso".
[x] **Diseño de Arquitectura:** Se definió el uso de Custom Claims de Firebase Authentication como el pilar de la estrategia de seguridad.
[x] **Implementación de Backend:** Se desarrolló y añadió la Cloud Function `setClientRole` en `functions/index.js`.
[x] **Mejora de Documentación:** Se actualizó el `manual.md` con ejemplos de flujo de trabajo más claros y las credenciales de acceso para Paula.

### 2.3. Archivos Clave Modificados o Creados

*   **MODIFY:** `c:\proyectos\integra-rh\functions\index.js` (Se añadió la nueva Cloud Function).
*   **MODIFY:** `c:\proyectos\integra-rh\context\manual.md` (Se mejoró el contenido y se añadieron credenciales).

---

## 3. Arquitectura y Contratos (Para Trabajo en Paralelo)

### 3.1. Interfaces y Contratos de API

**Interfaz/Endpoint:** `setClientRole` (Cloud Function `onCall`)
**Descripción:** Asigna claims de cliente a un usuario. Requiere que el llamador sea administrador.
**Parámetros/Request Body:**
```json
{
  "email": "usuario_cliente@ejemplo.com",
  "clientId": "id_del_documento_del_cliente_en_firestore"
}
```
**Valor de Retorno/Response (Éxito):**
```json
{
  "success": true,
  "message": "El usuario usuario_cliente@ejemplo.com ahora tiene rol de cliente."
}
```

---

## 4. Estado y Próximos Pasos

### 4.1. Bloqueos y Decisiones Pendientes

*   **Decisión Pendiente:** Se debe asignar manualmente el custom claim `{admin: true}` al usuario de Paula (`prueba@vcorp.mx`) para que pueda ejecutar la nueva función.

### 4.2. Siguientes Pasos para ESTE Módulo

1.  Asignar el rol de administrador a Paula.
2.  Construir la interfaz en el frontend para que Paula pueda llamar a la función `setClientRole`.
3.  Actualizar las reglas de seguridad de Firestore (`firestore.rules`) para que utilicen los nuevos claims y restrinjan el acceso de los clientes.

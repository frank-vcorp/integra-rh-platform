# CHK_2025-11-02_1415 — Integra RH v2

Referencia PROYECTO.md: PVM-WEB-03 [>], PVM-API/Procesos [>], PVM-OBS/DEV [✓] ajustes.

## Qué se hizo
- Psicométricas
  - UI simplificada: asignación por pruebas individuales (sin batería) en `CandidatoDetalle`.
  - Webhook fortalecido: actualiza estatus, guarda JSON y PDF; idempotencia y secret opcional.
  - Cooldown de consultas (`PSICOMETRICAS_CHECK_COOLDOWN_SECONDS`).
- Procesos
  - `processes.create` ahora genera `consecutivo` y `clave` (ej. `ILA-2025-001`).
  - Campo `medioDeRecepcion` agregado (whatsapp/correo/teléfono/boca_a_boca/portal/presencial/otro).
  - UI: CandidatoDetalle pide “¿Cómo llegó el proceso?” y ProcesoDetalle lo muestra.
  - Cambio de estatus desde ProcesoDetalle (`processes.updateStatus`).
  - Calificación final (`processes.updateCalificacion`).
  - Generación de dictamen (`processes.generarDictamen`) y visualización de enlace.
  - Fix de routing: `/procesos/:id` separado para evitar 404.
- Puestos
  - Endpoints `posts.list` y `posts.create` añadidos; UI ya opera sin 404.
- Documentos
  - Subida en candidato restablecida (Storage) usando `storage.bucket()` por defecto.
  - Dictamen y PDFs también usan bucket por defecto.
- Infra/Auth
  - Unificación de bucket (firebasestorage.app) y carga explícita de credenciales de servicio.
  - Logs no sensibles al arrancar con `project_id` y `storage bucket`.
- Directivas y docs
  - `context/Directivas_Unificadas.md`, `context/Instrucciones_Personalizadas.md`.
  - Paridad Functions→tRPC: `context/varios/LEGACY_FUNCTIONS_PARITY.md`.

## Cómo validar
- Server: `pnpm tsx watch ./server/_core/index.ts` y verificar logs:
  - `[FirebaseAdmin] Initialized with explicit service account. project_id: integra-rh`
  - `[FirebaseAdmin] Using storage bucket: integra-rh.firebasestorage.app`
- Candidatos:
  - Subir documento → aparece en lista (URL firmada).
- Psicométricas:
  - Asignar pruebas; (opcional) enviar webhook a `/api/webhooks/psicometricas` con `x-psico-secret` si configurado → guarda JSON/PDF.
- Procesos:
  - Crear proceso desde Candidato → `clave` autogenerada.
  - Cambiar estatus; fijar calificación; generar dictamen → aparece enlace y documento tipo DICTAMEN.
- Puestos:
  - Crear y listar sin errores 404.

## Configuración y entorno
- `.env` en `integra-rh-manus/` (resumen relevante):
  - `FIREBASE_STORAGE_BUCKET=integra-rh.firebasestorage.app`
  - `VITE_FIREBASE_STORAGE_BUCKET=integra-rh.firebasestorage.app`
  - `GOOGLE_APPLICATION_CREDENTIALS=./firebase-admin-sdk.json` (project_id = integra-rh)
  - `PSICOMETRICAS_TOKEN`, `PSICOMETRICAS_PASSWORD`, `PSICOMETRICAS_WEBHOOK_SECRET` (opcional), `PSICOMETRICAS_CHECK_COOLDOWN_SECONDS=900`
  - `VITE_API_URL=/api/trpc` y `VITE_FIREBASE_*` del proyecto web

## Pendientes próximos
- Documentos por Proceso: formulario de subida/eliminación en ProcesoDetalle.
- RBAC básico UI+API: ocultar acciones admin a clientes y reforzar guards.
- Webhook Psicométricas: validación de firma/HMAC e idempotencia por `asignacionId` a nivel documento.
- UX: toast con link tras generar dictamen y refresco automático de listas de documentos.
- Sincronizar `.env.example` con variables finales y comentarios.


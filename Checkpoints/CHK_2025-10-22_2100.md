# Dossier de Checkpoint: INTEGRA-RH

**ID del Checkpoint:** 2025-10-22_2100

**Módulo/Componente:** `FEAT-ADM-01: Módulo de Administración de Usuarios`

**Agente Principal:** Codex-CLI

**Tareas PROYECTO.md Asociadas:** `FEAT-ADM-01` (Desbloqueo parcial)

---

## 1. Resumen Ejecutivo (Para el Director de Proyecto)

**Objetivo de la Sesión:** Desbloquear el panel de administración de usuarios que fallaba con `401 Unauthorized` al invocar `listUsers`.

**Estado al Finalizar:** Se logró cargar la lista de usuarios en el panel admin. El desbloqueo se consiguió implementando un fallback HTTP (`listUsersHttp`) con verificación manual del ID token y ajuste de CORS/App Check en backend, más un refresh forzado de token en frontend. La causa raíz sigue apuntando a incompatibilidad entre el SDK Firebase v8 (frontend) y el runtime/backend actual, por lo que se recomienda migrar a SDK v9 (modular) para volver a `https.onCall` sin fallback.

---

## 2. Snapshot Técnico (Para Continuidad de IA)

### 2.1. Qué se cambió

- Frontend (`public/index.html`):
  - Se fuerza refresh del token antes de leer claims y antes de invocar funciones protegidas (`getIdTokenResult(true)` y `getIdToken(true)`).
  - Se agregó un fallback en `loadAdminUsersPanel()`: si la callable `listUsers` responde `unauthenticated`, se invoca `fetch('/listUsersHttp')` con `Authorization: Bearer <ID_TOKEN>` y encabezado `X-Firebase-AppCheck` cuando disponible.
- Backend (`functions/index.js`):
  - Logs diagnósticos añadidos en `listUsers` (onCall) para inspeccionar `context.auth` y `context.app`.
  - Nueva función `listUsersHttp` (onRequest) que:
    - Responde preflight `OPTIONS` y añade encabezados CORS básicos.
    - Verifica manualmente el ID token con `verifyIdToken` y requiere `role === 'superAdmin'`.
    - Devuelve la misma estructura que la callable.
- Configuración (`firebase.json`):
  - Se añadió rewrite a `"/listUsersHttp"` -> `listUsersHttp` para mantener misma origin y evitar CORS del navegador.

### 2.2. Resultado

- El panel de administración ya carga la lista de usuarios utilizando el fallback HTTP cuando la callable falla con `401`.
- Los logs confirman que la callable aún llega sin `context.auth` (incompatibilidad SDK/reportada previamente), validando la hipótesis.

### 2.3. Archivos Clave Modificados

- MODIFY: `public/index.html`
- MODIFY: `functions/index.js`
- MODIFY: `firebase.json`

---

## 3. Riesgos y Consideraciones

- El flujo de “Guardar Rol” sigue usando la callable `manageUserRole`; si presenta el mismo problema de autenticación que `listUsers`, podría requerir un endpoint HTTP equivalente (`manageUserRoleHttp`) como medida temporal.
- Mantener dos vías (callable + HTTP) incrementa complejidad. Lo ideal es resolver la causa raíz migrando el frontend a SDK v9.

---

## 4. Próximos Pasos

### 4.1. Recomendación Principal (Migrar a Firebase SDK v9)

- Objetivo: eliminar la incompatibilidad y volver a `https.onCall` sin fallbacks.
- Acciones sugeridas:
  1. Reemplazar scripts CDN v8 en `public/index.html` por v9 modular (`/__/firebase/<latest>/firebase-app-compat.js` o modular puro con bundling si es posible). Preferible modular puro: `import { initializeApp } from 'firebase/app'`, etc. (si no hay bundler, usar compat por CDN como paso intermedio).
  2. Refactorizar inicialización:
     - `getAuth`, `getFirestore`, `getStorage`, `getFunctions(app, 'us-central1')`, `initializeAppCheck(app, { provider: new ReCaptchaV3Provider('...'), isTokenAutoRefreshEnabled: true })`.
  3. Cambiar llamadas a funciones: `httpsCallable(functions, 'listUsers')` y `httpsCallable(functions, 'manageUserRole')` con el objeto `functions` modular.
  4. Validar que `context.auth` llega poblado en `listUsers` y retirar gradualmente el fallback HTTP.

### 4.2. Plan B inmediato si se requiere operar sin migrar aún

- Crear `manageUserRoleHttp` (onRequest) con verificación de token y manejo de CORS, análogo a `listUsersHttp`.
- Frontend: si la callable de roles falla con `unauthenticated`, hacer POST a `/manageUserRoleHttp` con `Authorization: Bearer <ID_TOKEN>` y payload `{ uid, role, clientId? }`.

---

## 5. Validación

- Pruebas realizadas:
  - Carga del panel admin: lista de usuarios visible tras fallback HTTP.
  - Logs de `listUsers` muestran `hasAuth: false` (confirma la causa raíz), y `listUsersHttp` retorna `200` con usuarios.
- Pruebas pendientes:
  - Guardar cambio de rol; si falla por 401, aplicar `manageUserRoleHttp` temporal o migrar a v9.

---

## 6. Notas Operativas

- Mantener las variables de entorno (SendGrid y Psicométricas) configuradas; no se tocaron en esta sesión.
- Despliegue requerido para aplicar cambios: `functions` y `hosting`.


# Checkpoint — 2025-11-02 20:08

Resumen de avances

- Firebase Admin: inicializa con service account y bucket correcto (`integra-rh.firebasestorage.app`). Cargas de documentos de Candidatos y generación de Dictamen funcionan.
- Procesos: creación con `consecutivo` y `clave` (ej. ILA-2025-001); actualización de estatus y calificación; generación de dictamen almacenado y URL firmada.
- Visitas domiciliarias: backend para asignar/programar/actualizar/marcar/cancelar; calendario de visitas en `/visitas`; detalle en Proceso y Candidato.
- Documentos por proceso: upload/delete y listado con íconos y fechas.
- Encuestadores: router con list/create/update; UI de gestión.
- Portal de cliente (acceso híbrido): generación de enlaces con token (scope por candidato/proceso), validación, dashboard y vistas; orden de rutas corregido para no interceptar `/cliente/dashboard`.
- Fix de compilación: corregido error JSX en `client/src/App.tsx` (comentario duplicado sin cierre que rompía Vite).

Observaciones y pendientes

- Migración DB: asegurar columnas nuevas en `clientAccessTokens` (`procesoId`, `candidatoId`, `revokedAt`, `lastUsedAt`). Si no se ha aplicado, ejecutar la migración o aplicar `ALTER TABLE` manual según el motor.
- UI de correo: diálogo para enviar el enlace al cliente (SendGrid) y botón para revocar enlaces activos.
- RBAC visual: ocultar controles admin en UI para rol cliente (visitas CRUD, upload/delete docs, generar dictamen, etc.).
- Validaciones de visitas: no permitir fechas pasadas ni traslapes por encuestador.
- Dictamen PDF: reemplazar `.txt` por PDF con plantilla y `contentType: application/pdf`.
- Webhook psicométricas: opción de HMAC y mayor idempotencia (ya hay base).

Verificaciones rápidas

- Al arrancar, el log debe mostrar: `Using storage bucket: integra-rh.firebasestorage.app`.
- Rutas cliente: probar `/cliente/:token` con enlace recién generado y `/cliente/dashboard`.
- Subida de documentos: en Candidato y en Proceso; generación de dictamen.

Comandos útiles

- Iniciar server: `pnpm tsx watch ./server/_core/index.ts`

Notas de entorno

- `.env` del proyecto debe incluir `FIREBASE_STORAGE_BUCKET=integra-rh.firebasestorage.app` y variables Vite requeridas (`VITE_*`). Evitar registrar credenciales en texto plano fuera de `.env`.

Siguientes pasos sugeridos (prioridad)

1) UI de email + revocar enlace para portal de cliente.
2) RBAC visual para rol cliente.
3) Validaciones de visitas (fechas y traslapes).
4) Dictamen en PDF con plantilla.
5) Reforzar webhook de psicométricas.


# Checkpoint Maestro — Integra RH (2025‑11‑01)

Este documento deja un snapshot completo del estado actual del sistema, su arquitectura, tecnologías, variables de entorno, rutas de API, esquema de datos y flujos clave. Úsalo como punto de partida para nuevos entornos o para retomar trabajo.

---

## 1. Resumen Ejecutivo
- App web full‑stack para gestión de RRHH (clientes, candidatos, puestos, procesos, psico, documentos, portal de cliente).
- Frontend React 19 + Vite 7 + Tailwind 4 + tRPC + React Query.
- Backend Node/Express + tRPC + Firebase Admin + Drizzle ORM (MySQL/TiDB).
- Autenticación: Firebase Auth (Web) con Google; verificación con Admin en el servidor.
- Almacenamiento: Firebase Cloud Storage (bucket appspot.com) con URLs firmadas.
- Integraciones: PsicométricasMx (REST), SendGrid (emails).
- Infra DB: Railway (MySQL 8), base activa: `integra_rh_v2`.

---

## 2. Arquitectura
- Monorepo local con subproyecto de app: `integra-rh-manus/`.
- Servidor “core” unificado (Vite + Express) en desarrollo: `/server/_core/index.ts` (ruta API base `/api/trpc`).
- Router modular de tRPC: `/server/routers/index.ts` (composición de routers funcionales).
- Cliente: raíz Vite en `client/` (alias `@` → `client/src`).

```
client (Vite React)  ← tRPC →  server (Express+tRPC)  ←→  MySQL (Cloud SQL)
          ↑                                   ↑      ←→  Firebase Admin (Auth/Storage)
       Firebase Web SDK                     Integraciones: Psicométricas, SendGrid
```

---

## 3. Tecnologías y versiones
- Lenguaje: TypeScript 5.9 / Node 22
- Frontend: React 19, Vite 7, Tailwind 4, @tanstack/react‑query 5, wouter, lucide-react
- Backend: Express 4, @trpc/server 11, superjson, dotenv, jose
- ORM: Drizzle ORM + mysql2
- Firebase: `firebase` (Web SDK) y `firebase-admin` (Admin SDK)
- Build: esbuild/tsx, vitest para tests (básico)

---

## 4. Variables de Entorno (claves y secretos)
Ubicación principal: `integra-rh-manus/.env` (no versionar). Plantilla: `integra-rh-manus/.env.example`.

- Client/Web (prefijo VITE_)
  - `VITE_API_URL=/api/trpc` — Base de tRPC (dev y prod unificados)
  - `VITE_FIREBASE_API_KEY` — Clave Web Firebase
  - `VITE_FIREBASE_AUTH_DOMAIN` — p. ej. `integra-rh.firebaseapp.com`
  - `VITE_FIREBASE_PROJECT_ID=integra-rh`
  - `VITE_FIREBASE_STORAGE_BUCKET=integra-rh.appspot.com`
  - `VITE_FIREBASE_MESSAGING_SENDER_ID`
  - `VITE_FIREBASE_APP_ID`
  - `VITE_FIREBASE_MEASUREMENT_ID` (opcional)
  - Branding: `VITE_APP_LOGO=/integra_rh_logo.png`, `VITE_APP_TITLE="Integra RH"`

- Server/Backend
  - `DATABASE_URL` — MySQL (Railway). Ej: `mysql://usuario:pass@gondola.proxy.rlwy.net:18090/integra_rh_v2`
  - `GOOGLE_APPLICATION_CREDENTIALS=./firebase-admin-sdk.json` — Ruta al JSON del SA
  - `FIREBASE_STORAGE_BUCKET=integra-rh.appspot.com` — Bucket GCS/Firebase
  - PsicométricasMx: `PSICOMETRICAS_TOKEN`, `PSICOMETRICAS_PASSWORD`
  - SendGrid: `SENDGRID_API_KEY`
  - (Core opcional) `JWT_SECRET`, `OAUTH_SERVER_URL`, `VITE_APP_ID` (si se reactiva OAuth Manus)

Notas de seguridad
- Rotación: regenerar credenciales y actualizar `.env`.
- Nunca versionar `.env` ni `firebase-admin-sdk.json`.
- URLs firmadas de Storage expiran (1 año actual); ajustar política según uso.

---

## 5. Comandos útiles
- Desarrollo unificado (recomendado):
  - `cd integra-rh-manus`
  - `pnpm install`
  - (opcional) `setx`/`$env:` de variables si no están en `.env`
  - `pnpm tsx watch ./server/_core/index.ts`
  - Abre: `http://localhost:3000`
- API y cliente por separado (alternativa):
  - API: `pnpm tsx watch ./server/index.ts`
  - Web: `pnpm vite` (y `VITE_API_URL` → `http://localhost:3000/api/trpc`)
- Migraciones DB:
  - `pnpm db:push`

---

## 6. Rutas tRPC (router activo)
Archivo raíz: `server/routers/index.ts`.

- `auth` — `me`, `logout`
- `clients` — list, getById, create, update, delete
- `posts` — list, listByClient
- `candidates` — list, getById, create, update, delete
- `processes` — list, getById, getByCandidate, create
- `workHistory` — getByCandidate, create, update, delete
- `candidateComments` — getByCandidate (filtra `public` si rol cliente), create (visibility)
- `documents` — getByCandidate, getByProcess, create, upload (Storage), delete
- `psicometricas` — `asignarBateria`, `reenviarInvitacion`, `consultarResultados`, `guardarReporte`
- `email` — `enviarInvitacionPsicometrica`
- `clientAccess` — `validateToken`, `getClientData`

Ruta HTTP adicional
- `POST /api/webhooks/psicometricas` — recepción de webhooks (placeholder conectado)

---

## 7. Esquema de Datos (Drizzle / MySQL)
- `users` (openId, name, email, role, clientId, lastSignedIn)
- `clients` (nombreEmpresa, contacto, email, etc.)
- `posts` (puestos, clienteId)
- `candidates` (clienteId?, puestoId?, datos de contacto, `psicometricos` JSON)
- `workHistory` (candidatoId, empresa, fechas, `tiempoTrabajado`, causales, observaciones)
- `candidateComments` (candidatoId, text, author, `visibility: public|internal`)
- `processes` (candidatoId, clienteId, puestoId, `clave`, `tipoProducto`, `estatusProceso`, fechas)
- `documents` (candidatoId?, procesoId?, tipoDocumento, nombreArchivo, `url` TEXT, `fileKey` TEXT, mimeType, tamaño, uploadedBy)
- `clientAccessTokens` (token, clientId, expiresAt, lastUsedAt)

---

## 8. Flujos Clave
- Autenticación
  - Web: Firebase Auth (Google) → `getIdToken()`; el cliente añade `Authorization: Bearer <token>` en cada request tRPC.
  - Server: `verifyIdToken` (Admin) + upsert/lookup de usuario.
- PsicométricasMx
  - Asignar: `agregaCandidato` (Token, Password, Candidate, Email, Tests CSV, Battery opcional, Vacancy opcional). Devuelve `clave`.
  - Persistencia: se guarda `psicometricos.clavePsicometricas` y `estatus: Asignado`.
  - Reenviar: `reenviarInvitacion` (Clave).
  - Resultados: `consultaResultado` (Pdf=false → JSON; Pdf=true → PDF binario). PDF se almacena en Documents con URL firmada.
- Documentos
  - Upload desde CandidatoDetalle (CV, INE, etc.): se sube a `gs://<bucket>/candidates/<id>/...`, registro en `documents`.
- Procesos
  - Crear desde candidato (cliente asignado + puesto + tipo); listado y vista de detalle.

---

## 9. Frontend (páginas relevantes)
- `CandidatoDetalle`: historial laboral (CRUD), comentarios (interno/público), documentos (upload + iconos), psico (asignar/reenviar/ver/guardar), procesos (listar y crear).
- `Procesos`: listado general + creación; `ProcesoDetalle`: datos + documentos.
- `Clientes`, `Puestos`, `Candidatos`, `Dashboard`.
- Portal de cliente: `ClienteAcceso`, `ClienteDashboard`, `ClienteProcesoDetalle`, `ClienteCandidatoDetalle`.

---

## 10. Configuración de Firebase
- Web SDK: `client/src/lib/firebase.ts` toma variables `VITE_FIREBASE_*`.
- Admin SDK: `server/firebase.ts` usa `GOOGLE_APPLICATION_CREDENTIALS` y autoinicializa; acceso a Auth/Firestore/Storage.
- Bucket recomendado: `integra-rh.appspot.com`.

---

## 11. Puesta en Marcha Rápida
1) `cp integra-rh-manus/.env.example integra-rh-manus/.env` y completar claves.
2) Colocar `firebase-admin-sdk.json` en `integra-rh-manus/` y apuntar `GOOGLE_APPLICATION_CREDENTIALS`.
3) `pnpm install` en `integra-rh-manus/`.
4) `pnpm db:push` (aplica migraciones a Cloud SQL).
5) `pnpm tsx watch ./server/_core/index.ts` y abrir `http://localhost:3000`.

---

## 12. Operación y Rotación de Claves
- Firebase Web: rotar desde consola → actualizar `.env` (VITE_*).
- Admin SDK: crear nuevo Service Account key → reemplazar archivo y variable.
- Psicométricas/SendGrid: regenerar tokens → actualizar `.env`.
- MySQL: redefinir usuario/contraseña y/o redes autorizadas; actualizar `DATABASE_URL`.

---

## 13. Backlog Siguiente (prioridad)
1) Psico
   - Selector dinámico de baterías (`/consultaBateria`) y estatus desde `/consultaCandidato`.
2) Proceso
   - Cambiar estatus, comentarios por proceso, upload de documentos por proceso.
3) Documentos
   - Eliminar, validación de tamaño y tipos; previsualización.
4) Seguridad por rol
   - Capas UI (admin vs cliente) y limpieza de mensajes/errores.
5) Portal cliente
   - Completar flows en vistas cliente y prueba integral de `clientAccess`.

---

## 14. Rutas/Archivos Clave
- Enrutador tRPC: `integra-rh-manus/server/routers/index.ts`
- Server core dev: `integra-rh-manus/server/_core/index.ts`
- Firebase Admin: `integra-rh-manus/server/firebase.ts`
- Integración Psico: `integra-rh-manus/server/integrations/psicometricas.ts`
- UI Candidato: `integra-rh-manus/client/src/pages/CandidatoDetalle.tsx`
- UI Proceso: `integra-rh-manus/client/src/pages/ProcesoDetalle.tsx`
- Env plantilla: `integra-rh-manus/.env.example`

---

## 15. Notas
- Si en dev ves 401 en `auth.me`, confirmar `GOOGLE_APPLICATION_CREDENTIALS` y dominios autorizados en Firebase Auth.
- Si falla upload de documentos: validar `FIREBASE_STORAGE_BUCKET` y permisos del SA.

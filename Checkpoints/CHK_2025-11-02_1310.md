# CHK_2025-11-02_1310 — Integra RH v2

Referencia PROYECTO.md: PVM-INT-API-01/02 [✓]; avances webhook Psicométricas y comentarios de proceso.

## Cambios realizados
- Webhook Psicométricas (backend):
  - `integrations/psicometricas.handleWebhookPsicometricas` ahora:
    - Identifica evento y clave de asignación de forma tolerante.
    - Ubica candidato por `psicometricos.clavePsicometricas` (helper en DB).
    - Actualiza `psicometricos.estatus` y guarda `resultadosJson`.
    - Si estatus => Completado: descarga PDF y lo registra en `documents` (Storage + URL firmada).
  - DB: `getCandidateByPsicoClave` usando `JSON_EXTRACT`.
- Comentarios por Proceso:
  - API tRPC: `server/routers/processComments.ts` (getByProcess, create) y agregado al `appRouter`.
  - UI: sección de comentarios en `ProcesoDetalle` (lista + diálogo para crear; guarda autor del contexto y estatus actual de referencia).

## Cómo validar
- Lanzar server dev y enviar POST a `/api/webhooks/psicometricas` con un payload simulado:
  `{ "evento": "bateria_completada", "Clave": "<asignacionId>", "resultados": { ... } }`
  - Observar actualización en candidato y documento PDF agregado.
- Ir a ProcesoDetalle:
  - Cambiar estatus y guardar (ver tarea previa).
  - Agregar comentario y ver listado actualizado.

## Notas
- Requiere `.env`: `FIREBASE_STORAGE_BUCKET`, `GOOGLE_APPLICATION_CREDENTIALS`, DB correcta.
- El mapeo exacto del payload de Psicométricas puede variar; el handler es tolerante, pero se recomienda ajustar a los nombres definitivos en producción.


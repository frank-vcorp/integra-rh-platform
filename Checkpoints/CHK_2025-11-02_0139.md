# CHK_2025-11-02_0139 — Integra RH v2

Referencia PROYECTO.md: Portal Cliente + Visitas + Documentos.

## Avances desde el último corte
- Storage
  - Bucket unificado a firebasestorage.app; Admin carga credencial explícita.
  - Subidas operativas: documentos de candidato y dictamen de proceso.
- Encuestadores
  - Router tRPC `surveyors` (list, listActive, create, update) registrado.
- Visitas (domiciliarias)
  - Backend: assign/schedule/update/markDone/cancel + listVisits (filtra por cliente si rol=client).
  - ProcesoDetalle: sección para gestionar visitas.
  - Calendario global `/visitas` con filtros por encuestador/cliente y lista del día.
  - CandidatoDetalle: sección “Visitas domiciliarias” por proceso.
- Documentos por Proceso
  - `documents.upload` ahora acepta `procesoId`; UI de subida/eliminación en ProcesoDetalle.
- Correcciones UI
  - Menú admin y cliente ajustados (Visitas). Fix de sintaxis en DashboardLayout.

## Decisión: Acceso Híbrido para Clientes
- Fase 1 (enlace seguro)
  - Token con alcance (clientId, procesoId?, candidatoId?) + TTL (14 días por defecto).
  - Email con CTA a `/cliente/:token`; revocación/renovación desde el panel interno.
  - Solo lectura (procesos, candidatos, documentos públicos) + comentarios “públicos”.
- Fase 2 (cuenta permanente)
  - Creación opcional de usuario Firebase (rol=client) vinculado al `clientId`.
  - El cliente inicia sesión en `/login` y accede al mismo dashboard con persistencia.

## Plan técnico inmediato (Híbrido)
1) DB/Router: extender `clientAccessTokens` con `scope`, `expiresAt`, `revokedAt`, `lastAccessAt`.
2) tRPC `clientAccess`:
   - `create({ clientId, procesoId?, candidatoId?, ttlDays })` → { token }
   - `revoke({ id })`, `renew({ id, ttlDays })`, `getStatus({ id })`
3) Email SendGrid: plantilla “Acceso al estatus” con link y expiración.
4) UI:
   - Botón “Generar enlace de acceso” en CandidatoDetalle/ProcesoDetalle + copiar/enviar.
   - En ClienteDashboard: indicador de acceso por token vs cuenta.
5) Seguridad:
   - Guardas en `clientAccess` para alcance/expiración; hash de token en DB.

## Variables .env requeridas
- SENDGRID_API_KEY (ya presente)
- (Opcional) CLIENT_ACCESS_TTL_DAYS_DEFAULT=14

## Próximos cortes
- Implementar Fase 1 completa; luego onboarding de cuenta permanente desde el portal.

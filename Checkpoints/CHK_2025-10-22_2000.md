# Dossier de Checkpoint: INTEGRA-RH

**ID del Checkpoint:** 2025-10-22_2000

**Módulo/Componente:** `FEAT-ADM-01: Módulo de Administración de Usuarios`

**Agente Principal:** Frank-Director

**Tareas PROYECTO.md Asociadas:** `FEAT-ADM-01` (Bloqueado)

---

## 1. Resumen Ejecutivo (Para el Director de Proyecto)

**Objetivo de la Sesión:** Desbloquear la funcionalidad del panel de administración de usuarios, que fallaba con un error `401 Unauthorized` al llamar a la Cloud Function `listUsers`.

**Estado al Finalizar:** **La tarea `FEAT-ADM-01` permanece bloqueada.** A pesar de una sesión de depuración exhaustiva donde se resolvieron múltiples problemas subyacentes (permisos de IAM, configuración de `firebase.json`, inicialización del SDK del cliente), el error `401 Unauthorized` persiste. El diagnóstico final apunta a una sutil pero crítica incompatibilidad entre la versión del SDK de Firebase del cliente (`v8.10.1`) y el runtime del backend, que impide que el contexto de autenticación (`context.auth`) se propague correctamente a la función, a pesar de que los tokens son validados por la plataforma.

---

## 2. Snapshot Técnico (Para Continuidad de IA)

### 2.1. Descripción Funcional

Se intentó resolver el error `401 Unauthorized` que impide que el panel de administración de usuarios (`index.html`) obtenga la lista de usuarios de la función `listUsers`. Los logs del backend confirman que los tokens de autenticación y de App Check son válidos (`auth: "VALID", app: "VALID"`), pero la función falla internamente porque el objeto `context.auth` llega como `null`, activando la guarda de seguridad de "no autenticado".

### 2.2. Checklist de Tareas Técnicas Completadas

[x] **Diagnóstico de IAM:** Se identificó y corrigió la falta de permisos en la cuenta de servicio, asignando el rol `Administrador de Firebase Authentication`.
[x] **Configuración de Hosting:** Se corrigió el archivo `firebase.json` para incluir `rewrites` explícitos para cada Cloud Function, asegurando el enrutamiento correcto desde Firebase Hosting.
[x] **Configuración del Cliente:** Se ajustó la inicialización del SDK de funciones en `index.html` para especificar explícitamente la región (`us-central1`).
[x] **Refresco de Token:** Se implementó un refresco forzado del token de usuario (`getIdTokenResult(true)`) antes de llamar a las funciones para garantizar la validez del token.
[ ] **Resolución del Bloqueo:** El error `401` persiste a pesar de todas las correcciones.

### 2.3. Archivos Clave Modificados o Creados

*   **MODIFY:** `c:\proyectos\integra-rh\public\index.html` (Ajustes en la inicialización del SDK de Functions y en la lógica de obtención de tokens).
*   **MODIFY:** `c:\proyectos\integra-rh\firebase.json` (Añadidas reglas de `rewrites` para todas las funciones).
*   **CREATE:** `c:\proyectos\integra-rh\Checkpoints\CHK_2025-10-22_2000.md` (Este dossier).

---

## 4. Estado y Próximos Pasos

### 4.1. Bloqueos y Decisiones Pendientes

*   **BLOQUEO CRÍTICO:** El error `401 Unauthorized` persiste debido a que `context.auth` es nulo dentro de la Cloud Function. Se ha determinado que la causa raíz más probable es una incompatibilidad entre las versiones del SDK.

### 4.2. Siguientes Pasos para ESTE Módulo

1.  **Estrategia de Desbloqueo (Plan A):** La prioridad para la próxima sesión es **actualizar el SDK de Firebase en el cliente de la versión 8 a la versión 9 (API modular)**. Esta actualización es la acción más prometedora para resolver la incompatibilidad de raíz.
2.  **Refactorización:** La actualización a v9 requerirá refactorizar el código de inicialización y las llamadas a los servicios de Firebase en `public/index.html` para usar la nueva sintaxis modular.
3.  **Validación:** Una vez migrado el SDK, se volverá a probar la funcionalidad del panel de administración.

### 4.3. Estrategias Alternativas Discutidas (Plan B)

Al final de la sesión, se discutió una estrategia alternativa (Plan B) en caso de que la migración al SDK v9 presente complicaciones o no resuelva el problema:

*   **Cambiar a Funciones `onRequest`:** En lugar de usar `https.onCall`, se podrían refactorizar las funciones (`listUsers`, `manageUserRole`) a `https.onRequest`.
    *   **Frontend:** Utilizaría la API `fetch` estándar para llamar a las funciones, obteniendo manualmente el token de ID del usuario (`user.getIdToken()`) y enviándolo en la cabecera `Authorization: Bearer <token>`.
    *   **Backend:** La función `onRequest` extraería el token de la cabecera, lo verificaría manualmente con `admin.auth().verifyIdToken()`, y manejaría las cabeceras CORS explícitamente con el middleware `cors`.
    *   **Ventaja:** Este enfoque elimina la "magia" de las funciones `onCall`, dando un control total sobre el flujo de autenticación y proporcionando diagnósticos de error más claros.
